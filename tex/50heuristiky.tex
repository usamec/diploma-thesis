TODO poriadny nazov kapitoly

V tejto časti popíšeme niekoľko algoritmov, ktoré sú pomerne úspešné
na praktických inštanciách problému, ale väčšinou je ich teoretická
analýza pomerne ťažká. Popíšeme niekoľko heuristík, ktoré v pomerne krátkom čase
dávajú riešenie, ktoré je väčšinou blížko optimálneho. Aby sme vedeli odhadnúť
kvalitu týchto heuristík, najprv ale ukážeme niekoľko algoritmov na hľadanie dolného odhadu
veľkosti riešenia. Následne ešte vylepšíme algoritmus používajúci
celočíselné lineárne programovanie od \cite{duchenne}, aby
sme dokázali optimálne riešiť inštancie, ktoré majú najviac 400 vrcholov.

\section{Dolné odhady veľkosti riešenia}

\subsection{Odhad pomocou dvoch disjuktných kostier}

Pomerne priamočiarym dolným odhadom veľkosti riešenia je veľkosť
dvoch nakratších disjuktných kostier. My to jemne vylepšíme budeme používať
tzv. 1-kostry.

\begin{definicia}
1-kostra v grafe $G=(V, E)$ je zjednotenie kostry na vrcholoch $V \setminus \{1\}$
a dvoch hrán susedných s vrcholom $1$. 
\end{definicia}

\begin{lema}
Veľkosť dvoch najlacnejších disjuktných 1-kostier je najviac tak veľká ako dĺžka
riešenia problému dvoch obchodných cestujúcich.
\end{lema}

\begin{dokaz}
Každá hamiltonovská kružnica je 1-kostra. Riešenie problému dvoch obchodných cestujúcich
sú teda dve disjuktné 1-kostry.
\end{dokaz}

Dve najkratšie disjuktné 1-kostry môžeme hľadať v čase $O(m \lg m + n^2)$ pomocou algoritmu popísaného v
\cite{spanning2} -- nájdeme najkratšie disjuktné kostry na $V \setminus \{1\}$ a k vrcholu $1$ ešte
pridáme štyri najkratšie hrany.

Tento odhad sa dá vylepšiť pomocou techniky opísanej v \cite{heldtsp} a \cite{lower1}.
Jej princíp je nasledovný. Každému vrcholu prirádíme potenciál 
$p_i \in \mathbb{R}$.
A zavedenieme nové dĺžky hrán:
$$d(u, v) = c(u, v) + p_u + p_v$$

\begin{lema}
Majme potenciály $p_1, p_2, \dots, p_n$. Riešenie problému dvoch obchodných
cestujúcich pri dĺžkach $d(u,v)$ definovaných vyššie je rovnaké ako riešenie
problému dvoch obchodných cestujúcich pri dĺžkach $c(u,v)$.
\end{lema}

\begin{dokaz}
Majme hamiltonovskú kružnicu $v_1, v_2, \dots, v_n$ s dĺžkou $C = c(v_1, v_2) + c(v_2, v_3) +
\dots + c(v_n, v_1)$. Pokiaľ zavedieme dĺžky hrán $d(u,v)$ dostaneme cenu:
$$C^{'} = c(v_1, v_2) + p_{v_1} + p_{v_2} + c(v_2, v_3) + p_{v_2} + p_{v_3} + \dots +
c(v_n, v_1) + p_{v_n} + p_{v_1}$$
$$C^{'} = C + 2 \sum_{v \in V} p_v$$

To znamená, že ku dĺžke každej hamiltonovskej kružnice prirátame rovnaké číslo
a teda najlepšie riešenie pri upravených dĺžkach je rovnaké ako najlepšie
riešenie pri pôvodných dĺžkach.
\end{dokaz}

Podstatné je, že zmenou potenciálov vieme zmeniť najlacnejšie disjuktné 1-kostry. 
Našim cieľom bude nájsť také potenciály, aby rozdiel medzi dĺžkou najlacnejších
disjuktných 1-kostier a dĺžkou riešenia problému dvoch obchodných cestujúcich
bol čo najmenší. Nech $C$ je dĺžka riešenia problému dvoch obchodných cestujúcich
pri nulových potenciáloch. Nech $D$ je dĺžka dvoch najlacnejších disjuktných 1-kostier
pri potenciáloch $p_1, \dots, p_n$. Potom spomínaný rozdiel vieme vyjadriť ako:
$$C + 2 \sum_{v \in V} p_v - D$$

V našom prípade je $C$ nám neznáma konštanta a teda stačí minimalizovať výraz:
$$2 \sum_{v \in V} p_v - D$$

Vhodné potenciály vieme nájsť napríklad pomocou subgradientovej optimalizácie.
Dá sa totiž ukázať, že ak $d_v$ je súčet stupňov vrchola $v$ v obidvoch kostrách, tak
vektor so zložkami $g_v = 4 - d_v$ je subgradient pre vyššie spomínaný optimalizačný
problém.

Algoritmus optimalizácie sa dá popísať nasledovne. Na začiatku položíme všetky potenciály
ako $p^{(0)}_v = 0$. V $i$-tej iterácii si najprv zvolíme veľkosť kroku $t^{(i)}$. Následne
spočítame subgradienty $g^{(i)}_v = 4 - d^{(i-1)}_v$ a následne vyrátame nové potenciály ako:
$p^{(i)}_v = p^{(i-1)}_v + t^{(i)} g^{(i)}_v$. V našej implementácii sme $t^{(i)}$ volili ako
konštantu a iterácie opakovali dovtedy, kým sa výsledok zlepšoval.

\subsection{Dolný odhad pomocou štyroch najbližších susedov}

Ešte ukážeme jeden dolný odhad, ktorý je o trochu rýchlejší ako odhad pomocou kostier a navyše má
niektoré príjemné vlastnosti, ktoré sa ukážu neskôr.

\begin{definicia}
Daný je ohodnotený graf $G = (V, E)$. Graf $k$ najbližších susedov $G_s = (V, E)$ je orientovaný
graf taký, že z každého vrchola $v \in V$ vychádza $k$ najkratších hrán, ktoré s vrcholom $v$
susedia v $G$. 
\end{definicia}

\begin{lema}
Nech $s$ je celková dĺžka hrán v grafe $4$ najbližších susedov, nech $f$ je dĺžka najlacnejšieho
$4$-faktora a $t$ je dĺžka riešenia problému dvoch obchodných cestujúcich. Potom:
$$ \frac{1}{2} s \leq f \leq t$$
\end{lema}

\begin{dokaz}
Druhá nerovnosť vyplýva z toho, že dve hamiltonovské kružnice tvoria dokopy 4-faktor.
Prvá nerovnosť vyplýva z toho, že keď z každej hrany 4-faktoru spravíme dve orientované hrany, tak
dostaneme graf v ktorom z každého vrchola vychádzajú práve 4 hrany.
\end{dokaz}

My budeme hľadať graf $4$ najbližších susedov. Vieme ho nájsť pomerne priamočiaro v čase lineárnom
od počtu hrán. Opäť môžeme použiť aj transformáciu pomocou potenciálou. Cieľom je tento krát
dostať hodnotu $s/2$ čo najbližšie k hodnote $f$ (keďže najlacnejší 4-faktor sa pri zmene
potenciálov nezmení). Celý postup subgradientovej optimalizácie je rovnaký ako pri disjuktných
1-kostrách.

\begin{poznamka}
Vedeli by sme aj priamo hľadať najlacnejší $4$-faktor prevedením na hľadanie najlacnejšieho
$1$-faktora v správne pozmenenom grafe. Výhoda nášho prístupu sa ukáže neskôr, keď budeme
vyhľadávať hrany, ktoré zaručene nepoužijeme v optimálnom riešení.
\end{poznamka}

\section{Heuristiky na hľadanie horného odhadu veľkosti riešenia}

Na hľadanie horného odhadu veľkosti riešenia použijeme upravenú Lin-Kernighanovu heuristiku pre
problém obchodného cestujúceho (\cite{link}). Táto heuristika postupne vylepšuje nájdené
riešenie pomocou lokálnych zmien. V každom kroku vyberie množinu $k$ hrán $X$, ktoré z aktuálneho
riešenia odstráni a množinu $k$ hrán $Y$, ktorú do riešenia pridá. Tejto operácii sa zvykne
hovoriť aj $k$-opt krok, v našej implementácii budeme používať $k$ maximálne 5.
Lin-Kernighanova heuristika kladie na tieto množiny ešte niekoľko obmedzení:

\begin{itemize}
\item Hrany z $X \cup Y$ musia tvoriť cyklus. Kroku, ktorých spĺňa túto podmienku
hovoríme aj sekvenčný $k$-opt krok. Na tomto cykle sa striedavo budú vyskytovať hrany z množín
$X$ a $Y$.
\item Hrany z $Y$ musia byť podmnožinou tzv. množiny kandidátov. Množina kandidátov je množina hrán,
o ktorej predpokladáme, že väčšina z hrán riešenia bude práve z nej. Obvykle je množina kandidátov
tvorená tak, že pre každý vrchol zoberieme $m$ najkratších hrán, ktoré s ním susedia. V našej
implementácii sme položili $m = 8$.
\end{itemize}

TODO obrázok

Sekvenčné $k$-opt kroky vieme hľadať priamočiaro pomocou rekurzie -- v každom kroku si vyberieme,
ktorú hranu pridáme do množiny $X$ alebo $Y$ (postupujeme striedavo), začíname najprv množinou $X$.
Po pridaní hrany do množiny $X$ skúsime uzavrieť cyklus (ignorujeme, či hrana, ktorá uzavrie
cyklus je z množiny kandidátov). A skontrolujeme, či po takomto ťahu dostaneme stále hamiltonovskú
kružnicu a či jej dĺžka bude kratšia. V momente, keď nájdeme vhodný ťah aplikujeme ho -- t.j.
nehľadáme najlepší $k$-opt ťah.

Zároveň si pri rekurzii počítame doterajší zisk, t.j. rozdiel medzi dĺžkou odobraných a pridaných hrán.
Pokiaľ chceme, aby náš $k$-opt krok bol dobrý, tak jeho zisk musí byť kladný. My použijeme ešte
agresívnejšie orezanie -- požadujeme, aby po každom kroku rekurzie sme malý kladný zisk. Toto vôbec
neobmedzí prehľadané kroky, lebo ak máme celkovo kladný zisk, tak vieme cyklus prejsť v takom
poradí, aby bol zisk po každom kroku kladný.

\medskip

V našom prípade máme hamiltonovské kružnice dve. Priamočiara implementácia by mohla pre každý
$k$-opt ťah kontrolovať, či neporuší podmienku disjuktnosti ciest a povoliť len tie, ktoré ju
neporušujú.

Naše kroky budú mierne komplikovanejšie. Algoritmus na ich nájdenie by sa dal popísať nasledovne:
\begin{enumerate}
\item Nájdi $k$-opt krok v jeden z kružníc, ktorý túto kružnicu zlepší. Nech tento krok vymaže hrany
z množiny $X$ a pridá hrany z množiny $Y$.
\item Ak sa žiadna hrana z množiny $Y$ nenachádza v druhej kružnici, vykonaj tento krok.
\item Ak má prienik druhej kružnice a $Y$ veľkosť 1, tak nájdi v druhej kružnici najlacnejší $2$-opt
alebo $3$-opt krok, ktorý obsahuje túto hranu. Ak sa po vykonaní týchto krokov zlepší súčet dĺžok
kružníc, vykonaj tieto kroky.
\item V prípade, že má tento prienik veľkosť viac ako $1$, označme hrany v prieniku ako $e_1, \dots,
e_k$. Tieto hrany nám druhú kružnicu rozdelia na niekoľko ciest. Vyskúšame všetky možnosti ako tieto
cesty pospájať bez toho, aby sme použili hrany $e_1, \dots, e_k$ a vyberieme najlacnejšiu. Ak sa po
vykonaní týchto krokov zlepší súčet dĺžkov kružníc vykonaj tieto krokov.
\item Ináč nájdi iný $k$-opt krok v prvej kružnici.
\end{enumerate}

Tieto kroky opakujeme kým sa riešenie nedá zlepšiť. Pokiaľ sa zasekneme v lokálnom optime, tak sa pokúsime 
dostať tak, že spravíme niekoľko krokov, ktoré jednu cestu zlepšia a súcet nezhoršia o viac ako
$1\%$. A následne sa opäť snazíme znižovať celkovú dĺžku. Algoritmus skončí vtedy, keď sa už ani
po takýchto krokoch nepodarí riešenie zlepšiť.


